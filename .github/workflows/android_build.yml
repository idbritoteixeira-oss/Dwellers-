name: apk dweller

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
- name: Checkout Repository
  uses: actions/checkout@v4

- name: Set up JDK 17
  uses: actions/setup-java@v4
  with:
    java-version: '17'
    distribution: 'temurin'

- name: Set up Flutter
  uses: subosito/flutter-action@v2
  with:
    flutter-version: '3.27.0'
    channel: 'stable'
    cache: true

- name: Setup Gradle
  uses: gradle/actions/setup-gradle@v3
  with:
    gradle-version: 8.2

- name: Install dependencies
  run: flutter pub get

- name: Create local.properties
  run: |
    echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
    echo "sdk.dir=$ANDROID_SDK_ROOT" >> android/local.properties

- name: Restore Gradle Wrapper
  run: |
    cd android
    if [ -f ./gradlew ]; then
      chmod +x ./gradlew
      ./gradlew wrapper --gradle-version 8.2
    else
      gradle wrapper --gradle-version 8.2
      chmod +x ./gradlew || true
    fi
    cd ..

- name: Install Android SDK platforms & build-tools (robust)
  run: |
    set -euo pipefail
    # candidates for sdkmanager
    CANDIDATES=(
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
      "$ANDROID_SDK_ROOT/cmdline-tools/bin/sdkmanager"
      "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
      "/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager"
    )
    for p in "${CANDIDATES[@]}"; do
      if [ -x "$p" ]; then
        SDKMANAGER="$p"
        break
      fi
    done

    if [ -z "${SDKMANAGER:-}" ]; then
      echo "sdkmanager não encontrado — instalando commandlinetools..."
      mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
      cd /tmp
      curl -sSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline.zip
      unzip -q cmdline.zip
      mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
      # move unpacked content into latest (tolerante se structure variar)
      mv cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/" || true
      SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
    fi

    echo "Using sdkmanager: $SDKMANAGER"
    "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2" || true
    yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
  shell: bash

- name: Build APK
  run: flutter build apk --release

- name: Verify APK location (debug listing)
  if: always()
  run: |
    echo "Listing possible APK paths:"
    ls -la build/app/outputs/flutter-apk || true
    ls -la android/app/build/outputs/apk/release || true
    find build -type f -name "*.apk" -print || true
    find android -type f -name "*.apk" -print || true

- id: find_apk
  name: Find APK produced by build
  run: |
    set -euo pipefail
    echo "Searching for APK files in build/ and android/ ..."
    APK=""
    APK="$(find build -type f -name "*.apk" -print -quit 2>/dev/null || true)"
    if [ -z "$APK" ]; then
      APK="$(find android -type f -name "*.apk" -print -quit 2>/dev/null || true)"
    fi
    if [ -z "$APK" ]; then
      echo "No APK found"
      echo "apk_path=" >> "$GITHUB_OUTPUT"
      exit 0
    fi
    echo "Found APK: $APK"
    echo "apk_path=$APK" >> "$GITHUB_OUTPUT"
  shell: bash

- name: Upload APK
  if: steps.find_apk.outputs.apk_path != ''
  uses: actions/upload-artifact@v4
  with:
    name: app-release
    path: ${{ steps.find_apk.outputs.apk_path }}

- name: Fail if no APK found
  if: steps.find_apk.outputs.apk_path == ''
  run: |
    echo "ERROR: No APK found after the build. Check build logs above for failures."
    exit 1
  shell: bash